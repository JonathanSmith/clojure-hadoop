<project name="clojure_hadoop" default="build" basedir=".">

  <property name="dir.src" location="${basedir}/src/main/clojure"/>
  <property name="dir.test" location="${basedir}/src/test/clojure"/>
  <property name="dir.examples" location="${basedir}/src/examples/clojure"/>
  <property name="dir.classes" location="${basedir}/target/classes"/>

  <path id="class.path">
    <fileset dir="${basedir}/lib">
      <include name="*.jar"/>
    </fileset>
    <pathelement location="${dir.src}"/>
    <pathelement location="${dir.test}"/>
    <pathelement location="${dir.examples}"/>
    <pathelement location="${dir.classes}"/>
  </path>

  <target name="prepare">
    <mkdir dir="${dir.classes}"/>
  </target>

  <!-- CLEAN BUILD DIRS -->
  <target name="clean"
          description="Delete compiled/generated files.">
    <delete dir="${dir.classes}"/>
  </target>

  <!-- CLOJURE CLASS FILE GENERATION -->
  <target name="compile_clojure"
          description="Generate ahead-of-time compiled Clojure classes.">
    <delete dir="${dir.classes}"/>
    <mkdir dir="${dir.classes}"/>
    <java classname="clojure.lang.Compile">
      <sysproperty key="clojure.compile.path" value="${dir.classes}"/>
      <classpath refid="class.path"/>
      <arg value="clojure-hadoop.job"/>
      <arg value="wordcount1"/>
      <arg value="wordcount2"/>
      <arg value="wordcount3"/>
    </java>
  </target>

  <!-- JAR FILE FOR HADOOP -->
  <target name="examples.jar"
          description="Create JAR for submission as a Hadoop job."
          depends="compile_clojure">
    <jar jarfile="${basedir}/examples.jar">
      <fileset dir="${dir.classes}">
        <include name="**/*.class"/>
      </fileset>
      <fileset dir="${dir.src}">
        <include name="**/*.clj"/>
      </fileset>
    </jar>
  </target>

  <!-- DEFAULT TARGET -->
  <target name="build" depends="examples.jar"/>

  <!-- RUN TESTS -->
  <target name="test" depends="compile_clojure"
          description="Run all tests">
    <java classname="clojure-hadoop.run-tests">
      <classpath refid="class.path"/>
    </java>
  </target>

</project>
